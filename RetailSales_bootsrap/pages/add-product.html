<!doctype html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="icon" href="../dist/img/mendian.gif" sizes="32x32" type="image/gif">
  <link rel="icon" href="../dist/img/mendian.gif" sizes="16x16" type="image/gif">
  <meta name="keywords" content="门店单据管理系统">
  <meta name="description" content="门店单据管理系统">
  <meta name="author" content="ajiho">
  <link rel="stylesheet" href="../lib/bootstrap-icons/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../lib/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../dist/css/bootstrap-admin.min.css">
  <title>新增库存商品信息</title>
</head>

<body class="bg-body-tertiary">

<div class="d-flex align-items-center justify-content-center">
  <div style="width: 400px; max-width: 100%; margin-top: 12vh;" class="p-2">
    <h2 class="text-center">新增库存商品信息</h2>
    <p class="text-secondary text-center">填写商品信息</p>

    <form id="form" class="form">
      <div class="mb-3">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-person-vcard"></i></span>
          <input type="text" class="form-control" id="name" name="name" maxlength="20" tabindex="2" autocomplete="on"
                 placeholder="请输入商品名称" required data-bv-container="#err_username"
                 pattern="^[\u4e00-\u9fa5A-Za-z0-9\uFF01-\uFFEF]{0,20}$">
        </div>

      </div>


      <div class="row mb-3">
        <label for="categoryId" class="col-sm-3 col-form-label text-sm-end">商品分类</label>
        <div class="col-sm-9">
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-tags-fill"></i></span>
            <select class="form-select" id="categoryId" name="categoryId" tabindex="6">
              <option value="">请选择分类</option>

            </select>
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <label for="unit" class="col-sm-3 col-form-label text-sm-end">计件方式</label>
        <div class="col-sm-9">
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-tags-fill"></i></span>
            <select class="form-select" id="unit" name="unit" tabindex="6">
              <option value="">请选择</option>
              <option value="瓶">瓶</option>
              <option value="袋">袋</option>
              <option value="千克">千克</option>
              <option value="盒">盒</option>
              <option value="箱">箱</option>
              <option value="件">件</option>
              <option value="支">支</option>
              <option value="套">套</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <label for="categoryName" class="col-sm-3 col-form-label text-sm-end">没有找到想要的分类？</label>
        <div class="col-sm-9">
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-bookmark-plus"></i></span>
            <input type="text" class="form-control" id="categoryName" name="categoryName" maxlength="20"
                   tabindex="2" aria-label="name" autocomplete="on" placeholder="自定义一个分类"
                   data-bv-container="#err_username" pattern="^[\u4e00-\u9fa5A-Za-z0-9\uFF01-\uFFEF]{0,20}$">
            <button type="submit" class="btn btn-primary" id="addCategoryButton">添加分类</button>
          </div>

        </div>
      </div>

      <!-- <div class="mb-3">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
          <input type="text" class="form-control" id="name" name="name" maxlength="20" tabindex="2" aria-label="name"
                 autocomplete placeholder="请输入姓名" required data-bv-container="#err_username"
                 pattern="^[\u4e00-\u9fa5A-Za-z0-9\uFF01-\uFFEF]{0,20}$">
        </div>

      </div>

      <div class="mb-3">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-telephone"></i></span>
          <input type="tel" class="form-control" id="phone" name="phone" tabindex="8" autocomplete
                 placeholder="请输入电话号码" required data-bv-container="#err_phone" maxlength="11">
        </div>
      </div> -->

      <!-- <div class="row mb-3">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-clipboard2-data"></i></span>
          <textarea class="form-control" id="reason" rows="6" name="reason" maxlength="200" tabindex="2"
                    autocomplete="on" placeholder="请输入申诉理由" data-bv-container="#err_username"
                    pattern="^[\u4e00-\u9fa5A-Za-z0-9\uFF01-\uFFEF]{0,200}$"></textarea>

        </div>
      </div> -->

      <!--
      <div class="mb-3">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-file-image"></i></span>
          <input type="file" class="form-control" id="profileImage" name="profileImage" tabindex="10"
            accept="image/*">
        </div>
      </div>

      <div class="mb-3 ">
        <div class="card-header bg-body text-center">
          用户头像
        </div>
        <div class="card-body text-center">
          <img id="imgEditPhoto" src="../dist/img/nophoto.png" alt="头像" class="rounded-circle   bsa-wh-100 "
            data-bs-toggle="modal" data-bs-target="#exampleModal">
        </div>
      </div> -->


      <div class="d-grid gap-2">
        <button class="btn btn-outline-primary" tabindex="12" type="submit"><i class="bi bi-shop"></i>
          新增库存商品信息
        </button>
      </div>


    </form>
    <br>
    <!-- <div class="d-grid gap-2">
      <button class="btn btn-outline-primary" tabindex="12" onclick="queryBan()"><i class="bi bi-search-heart"></i>
        输入账号可查询封禁信息
      </button>
    </div>
    <br>
    <div class="d-grid gap-2">
      <button class="btn btn-outline-primary" tabindex="12" onclick="redirectToLogin()"><i class="bi bi-back"></i>
        返回
      </button>
    </div> -->

    <!-- <div class="mt-3 text-center">
      <p>已有账号？<a href="login.html" class="link-success text-decoration-none">立即登录</a></p>
    </div> -->

  </div>
</div>


<!-- <div class="d-flex align-items-center justify-content-center">
<div style="width: 400px;max-width: 100%;margin-top: 12vh;" class="p-2">
  <h2 class="text-center">注册</h2> -->

<!-- <form id="form" class="form">
    <div class="mb-3">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
        <input type="text" class="form-control" placeholder="请输入账户" name="code" id="code" aria-label="username">
      </div>
    </div>

    <div class="mb-3">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
        <input type="text" class="form-control" placeholder="请输入名称" name="name" id="name" aria-label="name">
      </div>
    </div>

    <div class="mb-3">

      <div class="btn-group btn-group-toggle" data-toggle="buttons">
        <label class="btn btn-outline-secondary ">
          <input type="radio" name="gender" value="1" > 男
        </label>
        <label class="btn btn-outline-secondary">
          <input type="radio" name="gender" value="2"> 女
        </label>
      </div>
    </div>


    <div class="mb-3">
      <div class="input-group bsa-show_hide_password">
        <span class="input-group-text bg-white"><i class="bi bi-person-lock"></i></span>
        <input type="password" class="form-control" placeholder="请输入密码" name="password" autocomplete="off" id="password" aria-label="password">
        <span class="input-group-text bg-white bsa-cursor-pointer"><i class="bi bi-eye-slash"></i></span>
      </div>
    </div>

    <div class="mb-3">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="bi bi-telephone"></i></span>
        <input type="text" class="form-control" placeholder="请输入电话号码" name="phone" id="phone" aria-label="phone">
      </div>
    </div>

    <div class="d-grid gap-2">
      <button class="btn btn-outline-success" type="submit"><i class="bi bi-person-plus"></i> 注册</button>
    </div>

  </form>
</div>
</div>  -->


<script src="../lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../lib/jquery/dist/jquery.min.js"></script>
<script src="../lib/formvalidation/js/formValidation.js"></script>
<script src="../lib/formvalidation/js/framework/bootstrap.js"></script>
<script src="../lib/formvalidation/js/language/zh_CN.js"></script>
<script src="../dist/js/bootstrap-admin.min.js"></script>
<script src="../dist/js/app.js"></script>


<!-- <script type="text/javascript" src="../dist/js/bootstrapValidator-rock.js"></script> -->
<script type="text/javascript" src="../dist/js/rockjs-1.0.js"></script>
<script type="text/javascript" src="../pagejs/common.js"></script>


<script>

  var mvc = rock.initSvr(["category"]);
  var categoryService = mvc.findService("category");
  rock.initBasicMethod([categoryService]);

  function loadCategory() {
    var $search = $("#categoryId");
    var defaultOption = $search.find('option:first'); // 保存 "请选择分类" 选项

    $search.empty(); // 清空除了 "请选择分类" 选项之外的其他选项
    $search.append(defaultOption); // 重新添加 "请选择分类" 选项

    categoryService.queryAll({sort: "id"}, function (rtn, status) {
      if (rtn.hasError) {
        alert(rock.errorText(rtn, "查询列表失败!"));
      } else if (rtn.notEmpty) {
        var list = rtn.result, option = '<option value="%s">[%s] － %s</option>';
        var $search = $("#categoryId");
        $.each(list, function (i, vo) {
          $search.append(rock.format(option, [vo.id, vo.id, vo.name]));
          // $edit.append(rock.format(option, [vo.id, vo.code, vo.name]));
        });
      } else {
        alert("未查询到部门列表!");
      }
    });
  }

  // 获取按钮和输入框元素
  let addButton = document.getElementById('addCategoryButton');
  let categoryNameInput = document.getElementById('categoryName');
  let errorElement = null; // 错误提示元素

  // 添加点击事件监听器
  addButton.addEventListener('click', function (event) {
    event.preventDefault(); // 阻止表单的默认提交行为

    // 获取输入框的值
    let categoryName = categoryNameInput.value;

    // 校验输入框不为空
    if (categoryName.trim() === '') {
      // 输入框为空，显示错误提示
      showErrorMessage('输入框不能为空');
      return; // 停止执行后续逻辑
    }

    // 创建一个对象，包含要发送到后端的数据
    let data = {
      name: categoryName
    };

    // 使用 AJAX 发送数据到后端
    $.ajax({
      url: 'http://127.0.0.1:8081/voucher/category/addCategory',
      type: 'POST',
      //跨域
      xhrFields: {
        withCredentials: true
      },
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function (response) {
        if (response.result) {
          $.toasts({
            type: 'info',
            content: '添加分类成功',
            delay: 1000,
            onHidden: function () {
              loadCategory();
            }
          });
        } else {
          var errorMessage = rock.errorText(response, "添加分类失败!");
          $.toasts({
            type: 'danger',
            content: errorMessage,
            delay: 3000,
            onHidden: function () {
              if (response.errorCode === "1075") {
                $("#code").focus();
              }
              categoryNameInput.value = '';
            }
          });
        }

      }

    });
  });

  // 监听输入框的输入变化
  categoryNameInput.addEventListener('input', function () {
    hideErrorMessage(); // 隐藏错误提示
    categoryNameInput.classList.remove('error'); // 移除输入框的错误样式
  });

  // 显示错误提示
  function showErrorMessage(message) {
    // 如果已经存在错误提示元素，则更新其内容
    if (errorElement) {
      errorElement.textContent = message;
      return;
    }

    // 创建新的错误提示元素
    errorElement = document.createElement('div');
    errorElement.classList.add('error-message');
    errorElement.textContent = message;

    // 插入到输入框的下方
    categoryNameInput.parentNode.appendChild(errorElement);
    categoryNameInput.classList.add('error'); // 添加输入框的错误样式
  }

  // 隐藏错误提示
  function hideErrorMessage() {
    if (errorElement) {
      errorElement.parentNode.removeChild(errorElement);
      errorElement = null; // 重置错误提示元素
    }
    categoryNameInput.classList.remove('error'); // 移除输入框的错误样式
  }


  $(function ($) {

    _root.loginUser(null, function (rtn, status) {
      if (rtn.hasError) {
        alert(rock.errorText(rtn, "连接到服务器失败！"));
      } else if (rtn.notNull && rtn.result.admin == 0) {

        loadCategory();

        $("#form").formValidation({
          //验证字段

          fields: {
            name: {
              validators: {
                notEmpty: {
                  message: '商品名称不能为空！'
                },
                stringLength: {
                  min: 1,
                  max: 20,
                  message: '商品名称长度必须在1到20个字符之间'
                }
              }
            },


            categoryId: {
              validators: {
                notEmpty: {
                  message: '请选择分类'
                }
              }
            },
            unit: {
              validators: {
                notEmpty: {
                  message: '请选择信息'
                }
              }
            },


          }
        }).on('success.form.fv', function (e) {

          //阻止表单提交
          e.preventDefault();


          //得到表单对象
          let $form = $(e.target);
          // 获取数据
          let formData = $form.serializeArray();

          // 定义要忽略的输入字段名称
          let ignoredInputName = 'categoryName';


          // 过滤 formData 数组，删除不想要的输入字段
          let filteredFormData = formData.filter(item => {
            return item.name !== ignoredInputName;
          });
          // 将过滤后的 formData 数组转换为对象
          let formDataObject = {};
          filteredFormData.forEach(item => {
            formDataObject[item.name] = item.value;
          });

          // 将对象转换为 JSON 字符串
          let serializedData = JSON.stringify(formDataObject);
          console.log(serializedData);
          //得到序列化数据
          $.ajax({
            url: "http://127.0.0.1:8081/voucher/product/addProduct",
            method: 'post',
            contentType: 'application/json',
            data: serializedData,
          }).then(response => {

            if (response.result) {
              $.toasts({
                type: 'success',
                content: '添加成功！',
                delay: 1500,
                autohide: true,
                onHidden: function () {
                  parent.loadProduct(); // 调用父页面的 loadProduct 方法
                  parent.modalInstance.setData(true);
                  parent.modalInstance.close();

                }
              });
            } else if (response.hasError) {
              var errorMessage = rock.errorText(response, "添加失败!");
              $.toasts({
                type: 'danger',
                content: errorMessage,
                delay: 3050, // 将显示时间设置
                onShown: function () {
                  console.log(response.errorCode)
                  if (response.errorCode === "1075") {
                    $("#code").focus();
                  }
                }
              });

            }


          });

        });

      }

    })


  });

</script>
</body>

</html>
