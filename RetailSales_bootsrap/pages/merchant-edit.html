<!doctype html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="icon" href="dist/img/hualogo.gif" sizes="32x32" type="image/gif">
  <link rel="icon" href="dist/img/hualogo.gif" sizes="16x16" type="image/gif">
  <meta name="keywords" content="华裳在线汉服网络商城">
  <meta name="description" content="bootstrap华裳在线汉服网络商城">
  <meta name="author" content="ajiho">
  <link rel="stylesheet" href="../lib/bootstrap-icons/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../lib/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../dist/css/bootstrap-admin.min.css">
  <title>商家个人信息修改</title>
</head>

<body class="bg-body-tertiary py-3">
<div class="container-fluid">
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <form id="form">

        <div class="row mb-3">
          <label for="role" class="col-sm-3 col-form-label text-sm-end">用户角色</label>
          <div class="col-sm-9">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-person-hearts"></i></span>
              <select class="form-select" name="role" aria-label="role" id="admin" disabled>
                <option value="1" selected>华裳商家</option>
                <option value="0">商城员工</option>
              </select>
            </div>
            <div class="form-text">当前角色不可更改为其它角色</div>
          </div>
        </div>

        <div class="row mb-3" id="hide_id">
          <label for="id" class="col-sm-3 col-form-label text-sm-end">Id</label>
          <div class="col-sm-9">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-person-vcard"></i></span>
              <input type="text" class="form-control" id="id" name="id" tabindex="1" autocomplete="on" placeholder=""
                     required data-bv-container="#err_username" readonly>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <label for="code" class="col-sm-3 col-form-label text-sm-end">账号</label>
          <div class="col-sm-9">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-person-vcard"></i></span>
              <input type="text" class="form-control" id="code" name="code" maxlength="20" tabindex="2"
                     autocomplete="on"
                     placeholder="请输入账号" data-bv-container="#err_username" pattern="^[A-Za-z0-9]{0,20}$">
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <label for="name" class="col-sm-3 col-form-label text-sm-end">昵称</label>
          <div class="col-sm-9">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
              <input type="text" class="form-control" id="name" name="name" maxlength="20" tabindex="2"
                     aria-label="name" autocomplete="on" placeholder="请输入姓名" data-bv-container="#err_username"
                     pattern="^[\u4e00-\u9fa5A-Za-z0-9\uFF01-\uFFEF\s]{0,20}$">
            </div>
          </div>
        </div>


        <!-- <div class="row mb-3">
          <label for="nickname" class="col-sm-3 col-form-label text-sm-end">性别</label>
          <div class="col-sm-9">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-gender-ambiguous"></i></span>
              <select class="form-select" id="gender" name="gender" tabindex="6">
                <option value="">请选择性别</option>
                <option value="1">男</option>
                <option value="2">女</option>
              </select>
            </div>
          </div>
        </div> -->


        <div class="row mb-3">
          <label for="profileImage" class="col-sm-3 col-form-label text-sm-end">头像</label>
          <div class="col-sm-9">
            <div class="input-group ">
              <input type="file" class="form-control" id="profileImage" name="profileImage">
              <label class="input-group-text" for="avatar"><i class="bi bi-cloud-upload"></i>
                修改图片</label>
            </div>
          </div>
        </div>

        <div class="mb-3 ">
          <div class="card-header bg-body text-center">
            用户头像
          </div>
          <div class="card-body text-center">
            <img id="imgEditPhoto" src="../dist/img/nophoto.png" alt="头像" class="rounded-circle   bsa-wh-100 "
                 data-bs-toggle="modal" data-bs-target="#exampleModal">
          </div>
        </div>

        <div class="row mb-3">
          <label for="phone" class="col-sm-3 col-form-label text-sm-end">手机</label>
          <div class="col-sm-9">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-telephone"></i></span>
              <input type="tel" class="form-control" id="phone" name="phone" tabindex="8" autocomplete="on"
                     placeholder="请输入电话号码" required data-bv-container="#err_phone" maxlength="11">
            </div>
          </div>
        </div>


        <div class="row mb-3">
          <div class="col-sm-9 offset-sm-3 text-center">
            <button type="submit" class="btn btn-primary">确认修改</button>
          </div>
        </div>
      </form>
    </div>
  </div>


</div>
<!--回到顶部开始-->
<a href="javaScript:" class="bsa-back-to-top"><i class='bi bi-arrow-up-short'></i></a>
<!--回到顶部结束-->


<script src="../lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../lib/jquery/dist/jquery.min.js"></script>
<script src="../lib/formvalidation/js/formValidation.js"></script>
<script src="../lib/formvalidation/js/framework/bootstrap.js"></script>
<script src="../lib/formvalidation/js/language/zh_CN.js"></script>
<script src="../dist/js/bootstrap-admin.min.js"></script>
<script src="../dist/js/app.js"></script>
<script type="text/javascript" src="../dist/js/rockjs-1.0.js"></script>
<script type="text/javascript" src="../../hanfu_SJfront/pagejs/common.js"></script>
<script>

  $(function ($) {
    $("#hide_id").hide();

    //照片上传字段设置
    $("#profileImage").change((evt) => {
      var ele = evt.target, url;
      if (rock.isMsie()) {
        url = ele.value;
      } else {
        var file = ele.files[0];
        if (file) {
          url = window.URL.createObjectURL(file);
        }
      }
      $("#imgEditPhoto").attr("src", url);
    });

    // 从 sessionStorage 中获取数据并解析为对象
    var selectedUserData = JSON.parse(sessionStorage.getItem('selectedUserData'));

    //$("#admin").val(selectedUserData.admin);
    $("#id").attr("value", selectedUserData.id);
    $("#code").attr("value", selectedUserData.code);
    $("#name").attr("value", selectedUserData.name);
    //$("#gender").val(selectedUserData.gender);
    $("#phone").attr("value", selectedUserData.phone);
    if (selectedUserData.hasPhoto) {
      var mvc = rock.initSvr(["merchant"]);
      var Service = mvc.findService("merchant");
      $("#imgEditPhoto").attr("src", Service.url("photo") + "?id=" + selectedUserData.id);
    }


    $("#form").formValidation({
      //验证字段

      fields: {
        code: {
          validators: {
            notEmpty: {
              message: '账号不能为空'
            },
            stringLength: {
              min: 1,
              max: 20,
              message: '用户名长度必须在1到20个字符之间'
            }
          }
        },
        name: {
          validators: {
            notEmpty: {
              message: '姓名不能为空'
            },
            stringLength: {
              min: 1,
              max: 20,
              message: '用户名长度必须在1到20个字符之间'
            }
          }
        },

        // gender: {
        //     validators: {
        //         notEmpty: {
        //             message: '请选择性别'
        //         }
        //     }
        // },
        phone: {
          validators: {
            notEmpty: {
              message: '电话号码不能为空'
            },
            regexp: {
              regexp: /^\d{11}/,
              message: '请输入有效的11位电话号码!'
            }
          }
        },
        profileImage: {
          validators: {
            file: {
              extension: 'jpeg,jpg,png',
              type: 'image/jpeg,image/png,image/webp',
              maxSize: 5242880, // 5MB
              message: '请选择小于5MB的JPEG或PNG格式图片文件'
            }
          }
        }
        //...
      }
    }).on('success.form.fv', function (e) {

      //阻止表单提交
      e.preventDefault();


      //得到表单对象
      let $form = $(e.target);
      //获取数据
      let data = new FormData($form[0]); // 使用FormData对象

      // 获取照片文件
      let photoInput = document.getElementById('profileImage');
      if (photoInput.files.length > 0) {
        let photo = photoInput.files[0];
        data.append('photo', photo); // 添加照片数据到FormData对象
      }

      //得到序列化数据
      $.ajax({
        //跨域
        xhrFields: {
          withCredentials: true
        },
        url: "http://127.0.0.1:8082/hanfushopping/merchant/updateMerchant",
        method: 'post',
        data: data,
        processData: false,
        contentType: false,
      }).then(response => {
        if (response.result) {
          $.toasts({
            type: 'success',
            content: '修改用户信息成功！',
            delay: 1000,
            autohide: true,
            onHidden: function () {
              parent.modalInstance.setData(true);
              parent.modalInstance.close();
            }
          });
        } else if (response.hasError) {
          var errorMessage = rock.errorText(response, "修改信息错误!");
          $.toasts({
            type: 'danger',
            content: errorMessage,
            delay: 3050, // 将显示时间设置
            onShown: function () {
              if (response.errorCode === "1067") {
                $("#code").focus();
              }
            }
          });

        }

      });

    });


  });

</script>


</body>

</html>
