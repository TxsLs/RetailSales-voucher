<!doctype html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="icon" href="../dist/img/mendian.gif" sizes="32x32" type="image/gif">
  <link rel="icon" href="../dist/img/mendian.gif" sizes="16x16" type="image/gif">
  <meta name="keywords" content="门店单据管理系统">
  <meta name="description" content="bootstrap门店单据管理系统">
  <meta name="author" content="ajiho">
  <link rel="stylesheet" href="../lib/bootstrap-icons/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../lib/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../dist/css/bootstrap-admin.min.css">
  <title>个人资料</title>
</head>

<body class="bg-body-tertiary py-3">
<div class="container-fluid">
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-body">
      设置我的资料
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-9">
          <form id="form">

            <!-- <div class="row mb-3">
                <label for="role" class="col-sm-3 col-form-label text-sm-end">我的角色</label>
                <div class="col-sm-9">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i
                                class="bi bi-person-hearts"></i></span>
                        <select class="form-select" name="role" aria-label="role" id="role">
                            <option value="1" selected>超级管理员</option>
                        </select>
                    </div>
                    <div class="form-text">当前角色不可更改为其它角色</div>
                </div>
            </div> -->

            <div class="row mb-3" id="hide_id">
              <label for="username" class="col-sm-3 col-form-label text-sm-end">Id</label>
              <div class="col-sm-9">
                <div class="input-group">
                                        <span class="input-group-text bg-white"><i
                                          class="bi bi-person-vcard"></i></span>
                  <input type="text" class="form-control" id="id" name="id" tabindex="1"
                         autocomplete="on" placeholder="" required data-bv-container="#err_username">
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <label for="username" class="col-sm-3 col-form-label text-sm-end">账号</label>
              <div class="col-sm-9">
                <div class="input-group">
                                        <span class="input-group-text bg-white"><i
                                          class="bi bi-person-vcard"></i></span>
                  <input type="text" class="form-control" id="code" name="code" maxlength="20"
                         tabindex="2" autocomplete="on" placeholder="请输入账号"
                         data-bv-container="#err_username" pattern="^[A-Za-z0-9]{0,20}$">
                </div>
              </div>
            </div>
            <div class="row mb-3">
              <label for="nickname" class="col-sm-3 col-form-label text-sm-end">昵称</label>
              <div class="col-sm-9">
                <div class="input-group">
                  <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
                  <input type="text" class="form-control" id="name" name="name" maxlength="20"
                         tabindex="2" aria-label="name" autocomplete="on" placeholder="请输入姓名"
                         data-bv-container="#err_username"
                         pattern="^[\u4e00-\u9fa5A-Za-z0-9\uFF01-\uFFEF]{0,20}$">
                </div>
              </div>
            </div>

            <!-- <div class="row mb-3">
                <label for="nickname" class="col-sm-3 col-form-label text-sm-end">性别</label>
                <div class="col-sm-9">
                    <div class="d-flex align-items-center h-100">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender"
                                id="inlineRadio1" value="1" >
                            <label class="form-check-label" for="inlineRadio1">男</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="gender"
                                id="inlineRadio2" value="2">
                            <label class="form-check-label" for="inlineRadio2">女</label>
                        </div>
                    </div>
                </div>
            </div> -->

            <div class="row mb-3">
              <label for="nickname" class="col-sm-3 col-form-label text-sm-end">性别</label>
              <div class="col-sm-9">
                <div class="input-group">
                                        <span class="input-group-text bg-white"><i
                                          class="bi bi-gender-ambiguous"></i></span>
                  <select class="form-select" id="gender" name="gender" tabindex="6">
                    <option value="">请选择性别</option>
                    <option value="1">男</option>
                    <option value="2">女</option>
                  </select>
                </div>
              </div>
            </div>


            <div class="row mb-3">
              <label for="nickname" class="col-sm-3 col-form-label text-sm-end">头像</label>
              <div class="col-sm-9">
                <div class="input-group ">
                  <input type="file" class="form-control" id="profileImage" name="profileImage">
                  <label class="input-group-text" for="avatar"><i class="bi bi-cloud-upload"></i>
                    修改图片</label>
                </div>
              </div>
            </div>

            <div class="mb-3 ">
              <div class="card-header bg-body text-center">
                用户头像
              </div>
              <div class="card-body text-center">
                <img id="imgEditPhoto" src="../dist/img/nophoto.png" alt="头像"
                     class="rounded-circle   bsa-wh-100 " data-bs-toggle="modal"
                     data-bs-target="#exampleModal">
              </div>
            </div>

            <div class="row mb-3">
              <label for="phone" class="col-sm-3 col-form-label text-sm-end">手机</label>
              <div class="col-sm-9">
                <div class="input-group">
                  <span class="input-group-text bg-white"><i class="bi bi-telephone"></i></span>
                  <input type="tel" class="form-control" id="phone" name="phone" tabindex="8"
                         autocomplete="on" placeholder="请输入电话号码" required
                         data-bv-container="#err_phone" maxlength="11">
                </div>
              </div>
              <!-- <div id="err_phone" style="text-align: left;"></div> -->
            </div>

            <!-- <div class="row mb-3">
                <label for="phone" class="col-sm-3 col-form-label text-sm-end">手机</label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" id="phone" name="phone" value="">
                </div>
            </div> -->

            <!-- <div class="row mb-3">
                <label for="email" class="col-sm-3 col-form-label text-sm-end">邮箱</label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" id="email" name="email"
                        value="lujiahao@88.com">
                </div>
            </div>
            <div class="row mb-3">
                <label for="desc" class="col-sm-3 col-form-label text-sm-end">备注</label>
                <div class="col-sm-9">
                    <textarea class="form-control" id="desc" rows="3" name="desc"></textarea>
                </div>
            </div> -->

            <div class="row mb-3">
              <div class="col-sm-9 offset-sm-3">
                <button type="submit" class="btn btn-primary">确认修改</button>
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<!--回到顶部开始-->
<a href="javaScript:" class="bsa-back-to-top"><i class='bi bi-arrow-up-short'></i></a>
<!--回到顶部结束-->


<script src="../lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../lib/jquery/dist/jquery.min.js"></script>
<script src="../lib/formvalidation/js/formValidation.js"></script>
<script src="../lib/formvalidation/js/framework/bootstrap.js"></script>
<script src="../lib/formvalidation/js/language/zh_CN.js"></script>
<script src="../dist/js/bootstrap-admin.min.js"></script>
<script src="../dist/js/app.js"></script>
<!--假数据模拟,生产环境中请直接删除该js-->
<!-- <script src="../dist/js/bootstrap-admin.mock.js"></script> -->
<script type="text/javascript" src="../dist/js/rockjs-1.0.js"></script>
<script type="text/javascript" src="../pagejs/common.js"></script>
<script>

  $("#hide_id").hide();


  var ssoUser = null;  //当前用户
  $(function ($) {


    _root.loginUser({}, function (rtn) {

      if (rtn.hasError) {
        alert(rock.errorText(rtn, "获得当前用户失败！"));
      } else {
        ssoUser = rtn.result;
      }
      if (rock.isNull(ssoUser)) {
        $.toasts({
          type: 'danger',
          content: '未登录！请返回登录',
          delay: 3000,
          onHidden: function () {
            top.location.replace('login.html');

          }
        });
      } else {
        $("#id").attr("value", ssoUser.id);
        $("#code").attr("value", ssoUser.code);
        $("#name").attr("value", ssoUser.name);
        $("#gender").val(ssoUser.gender);
        $("#phone").attr("value", ssoUser.phone);
        if (ssoUser.hasPhoto) {
          var mvc = rock.initSvr(["employee"]);
          var Service = mvc.findService("employee");
          $("#imgEditPhoto").attr("src", Service.url("photo") + "?id=" + ssoUser.id);
        }


        //照片上传字段设置
        $("#profileImage").change((evt) => {
          var ele = evt.target, url;
          if (rock.isMsie()) {
            url = ele.value;
          } else {
            var file = ele.files[0];
            if (file) {
              url = window.URL.createObjectURL(file);
            }

          }


          $("#imgEditPhoto").attr("src", url);
        });


        //前端表单验证
        $('#form').formValidation({
          fields: {
            code: {
              validators: {
                notEmpty: {
                  message: '账号不能为空'
                },
                stringLength: {
                  min: 1,
                  max: 20,
                  message: '用户名长度必须在1到20个字符之间'
                }
              }
            },
            name: {
              validators: {
                notEmpty: {
                  message: '姓名不能为空'
                },
                stringLength: {
                  min: 1,
                  max: 20,
                  message: '用户名长度必须在1到20个字符之间'
                }
              }
            },


            gender: {
              validators: {
                notEmpty: {
                  message: '请选择性别'
                }
              }
            },
            phone: {
              validators: {
                notEmpty: {
                  message: '电话号码不能为空'
                },
                regexp: {
                  regexp: /^\d{11}/,
                  message: '请输入有效的11位电话号码!'
                }
              }
            },
            profileImage: {
              validators: {
                file: {
                  extension: 'jpeg,jpg,png',
                  type: 'image/jpeg,image/png',
                  maxSize: 5242880, // 5MB
                  message: '请选择小于5MB的JPEG或PNG格式图片文件'
                }
              }
            }
          }
        }).on('success.form.fv', function (e) {
          //阻止表单提交
          e.preventDefault();
          //得到表单对象
          let $form = $(e.target);
          //获取数据
          let data = new FormData($form[0]); // 使用FormData对象

          // 获取照片文件
          let photoInput = document.getElementById('profileImage');
          if (photoInput.files.length > 0) {
            let photo = photoInput.files[0];
            data.append('photo', photo); // 添加照片数据到FormData对象
          }

          //得到序列化数据
          $.ajax({
            //跨域
            xhrFields: {
              withCredentials: true
            },
            url: "http://127.0.0.1:8081/voucher/employee/updateSelfInfo",
            method: 'Post',
            data: data,
            processData: false,
            contentType: false,
          }).then(res => {


            if (res.result && data.get("code") == ssoUser.code) {
              $.toasts({
                type: 'success',
                content: '修改个人信息成功！',
                onHidden: function () {

                  top.location.replace('../index.html');
                }
              });
            } else if (res.errorCode == "1067") {
              var errorMessage = rock.errorText(res, "修改失败!")
              $.toasts({
                type: 'danger',
                content: errorMessage,
                onHidden: function () {

                  top.location.replace('../index.html');
                }
              });
            } else {
              _root.logout({}, (rtn) => {
                if (rtn.hasError || !rtn.result) {
                  $.toasts({
                    type: 'danger',
                    content: '注销登录出错!',

                  })

                } else {

                  $.toasts({
                    type: 'success',
                    content: '修改个人信息成功！（修改账号将会退出登录！）',
                    onHidden: function () {
                      top.location.replace('login.html');
                    }
                  });


                }
              });

            }

          });
        });
      }
    });
  });

</script>


</body>

</html>
