<!doctype html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="icon" href="dist/img/hualogo.gif" sizes="32x32" type="image/gif">
  <link rel="icon" href="dist/img/hualogo.gif" sizes="16x16" type="image/gif">
  <meta name="keywords" content="门店单据管理系统">
  <meta name="description" content="门店单据管理系统">
  <meta name="author" content="ajiho">
  <link rel="stylesheet" href="../lib/bootstrap-icons/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../lib/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../dist/css/bootstrap-admin.min.css">
  <title>添加进货单</title>
</head>

<body class="bg-body-tertiary py-3">
<div class="container-fluid">
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <form id="form">
        <form id="form" class="form">

          <!-- <div class="mb-3" id="hide_id">
<div class="input-group">
<span class="input-group-text bg-white"><i class="bi bi-person-vcard"></i></span>
<input type="text" class="form-control" id="merchantId" name="merchantId" readonly maxlength="20"
  tabindex="2" autocomplete placeholder="" required data-bv-container="#err_username"
  pattern="^[A-Za-z0-9]{0,20}$">
</div>
</div> -->

          <div class="row mb-3">
            <label for="productId" class="col-sm-3 col-form-label text-sm-end">商品名称</label>
            <div class="col-sm-9">
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-tags-fill"></i></span>
                <select class="form-select" id="productId" name="productId" tabindex="6">
                  <option value="">请选择商品</option>
                </select>
              </div>
            </div>
          </div>

          <!-- <div class="row mb-3">
            <label for="productName" class="col-sm-3 col-form-label text-sm-end">没有所要的商品？</label>
            <div class="col-sm-9">
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-bookmark-plus"></i></span>
                <input type="text" class="form-control" id="productName" name="productName" maxlength="20"
                  tabindex="2" aria-label="name" autocomplete="on" placeholder="自定义一个商品名称"
                  data-bv-container="#err_username" pattern="^[\u4e00-\u9fa5A-Za-z0-9\uFF01-\uFFEF]{0,20}$">
                <button type="submit" class="btn btn-primary" id="addProductButton">添加商品名称</button>
              </div>
            </div>
          </div> -->

          <div class="row mb-3">
            <label for="quantity" class="col-sm-3 col-form-label text-sm-end">进货数量</label>
            <div class="col-sm-9">
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-basket"></i></span>
                <input type="number" class="form-control" id="quantity" name="quantity" maxlength="20" tabindex="2"
                       aria-label="name" autocomplete="on" placeholder="请输入商品进货数量"
                       data-bv-container="#err_username"
                       pattern="^\d{0,20}$">
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <label for="price" class="col-sm-3 col-form-label text-sm-end">进货单价</label>
            <div class="col-sm-9">
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-currency-yen"></i></span>
                <input type="text" class="form-control" id="price" name="price" maxlength="20" tabindex="2"
                       aria-label="name" autocomplete="on" placeholder="请输入进货单价"
                       data-bv-container="#err_username">
              </div>
            </div>
          </div>


          <!-- <div class="row mb-3">
            <label for="categoryName" class="col-sm-3 col-form-label text-sm-end">没有找到想要的分类？</label>
            <div class="col-sm-9">
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-bookmark-plus"></i></span>
                <input type="text" class="form-control" id="categoryName" name="categoryName" maxlength="20"
                  tabindex="2" aria-label="name" autocomplete="on" placeholder="自定义一个分类"
                  data-bv-container="#err_username" pattern="^[\u4e00-\u9fa5A-Za-z0-9\uFF01-\uFFEF]{0,20}$">
                <button type="submit" class="btn btn-primary" id="addCategoryButton">添加分类</button>
              </div>

            </div>
          </div> -->

          <div class="row mb-3">
            <label for="supplierId" class="col-sm-3 col-form-label text-sm-end">供应商</label>
            <div class="col-sm-9">
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-tags-fill"></i></span>
                <select class="form-select" id="supplierId" name="supplierId" tabindex="6">
                  <option value="">请选择供应商</option>

                </select>
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <label for="supplierName" class="col-sm-3 col-form-label text-sm-end">没有找到所要的供应商？</label>
            <div class="col-sm-9">
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-bookmark-plus"></i></span>
                <input type="text" class="form-control" id="supplierName" name="supplierName" maxlength="20"
                       tabindex="2" aria-label="name" autocomplete="on"
                       placeholder="名称加电话号 例如: 供应商-1234567890"
                       data-bv-container="#err_username" pattern="^[\u4e00-\u9fa5A-Za-z]+-\d{10}$"
                       title="格式: 字符串-10个数字，例如: 示例-1234567890">
                <button type="submit" class="btn btn-primary" id="addSupplierButton">添加供应商</button>
              </div>

            </div>
          </div>


          <div class="row mb-3">
            <label for="emp" class="col-sm-3 col-form-label text-sm-end">操作人</label>
            <div class="col-sm-9">
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-bag-plus-fill"></i></span>
                <input type="text" class="form-control" id="emp" name="emp" maxlength="20" tabindex="2"
                       aria-label="emp" autocomplete placeholder="请输入员工编号" data-bv-container="#err_username"
                       pattern="^[\u4e00-\u9fa5A-Za-z0-9\uFF01-\uFFEF]{0,20}$">
              </div>
            </div>
          </div>


          <div class="mb-3 text-center">
            <button type="submit" class="btn btn-primary">添加进货单</button>
          </div>
          <br>
          <div class="mb-3 text-center">
            <button class="btn btn-primary add-product">没有此商品的库存信息点击此处添加</button>
          </div>
        </form>
    </div>
  </div>


</div>
<!--回到顶部开始-->
<a href="javaScript:" class="bsa-back-to-top"><i class='bi bi-arrow-up-short'></i></a>
<!--回到顶部结束-->
<script src="../lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../lib/jquery/dist/jquery.min.js"></script>
<script src="../lib/formvalidation/js/formValidation.js"></script>
<script src="../lib/formvalidation/js/framework/bootstrap.js"></script>
<script src="../lib/formvalidation/js/language/zh_CN.js"></script>
<script src="../dist/js/bootstrap-admin.min.js"></script>
<script src="../dist/js/app.js"></script>
<script src="../dist/js/rockjs-1.0.js"></script>
<script src="../pagejs/common.js"></script>
<script>
  // const priceInput = document.getElementById('price');
  // priceInput.addEventListener('input', function () {
  //   const inputValue = parseFloat(priceInput.value);
  //   const formattedValue = inputValue.toFixed(2);
  //   priceInput.value = formattedValue;
  // })

  // const priceInput = document.getElementById('price');
  // priceInput.addEventListener('blur', function () {
  //   const value = this.value.trim();
  //   if (value !== '') {
  //     const floatValue = parseFloat(value);
  //     if (!isNaN(floatValue)) {
  //       const formattedValue = floatValue.toFixed(2);
  //       this.value = formattedValue;
  //     }
  //   }
  // });
  // $("#hide_id").hide();


  var mvc = rock.initSvr(["product"]);
  var productService = mvc.findService("product");
  rock.initBasicMethod([productService]);

  function loadProduct() {
    var $search = $("#productId");
    var defaultOption = $search.find('option:first'); // 保存 "请选择分类" 选项

    $search.empty(); // 清空除了 "请选择分类" 选项之外的其他选项
    $search.append(defaultOption); // 重新添加 "请选择分类" 选项

    productService.queryAll({sort: "id"}, function (rtn, status) {
      if (rtn.hasError) {
        alert(rock.errorText(rtn, "查询列表失败!"));
      } else if (rtn.notEmpty) {
        var list = rtn.result, option = '<option value="%s">%s － %s</option>';
        var $search = $("#productId");
        $.each(list, function (i, vo) {
          $search.append(rock.format(option, [vo.id, vo.name, vo.categoryName]));
          // $edit.append(rock.format(option, [vo.id, vo.code, vo.name]));
        });
      } else {
        alert("未查询到部门列表!");
      }
    });
  }


  var mvc = rock.initSvr(["supplier"]);
  var supplierService = mvc.findService("supplier");
  rock.initBasicMethod([supplierService]);

  function loadSupplier() {
    var $search = $("#supplierId");
    var defaultOption = $search.find('option:first'); // 保存 "请选择分类" 选项

    $search.empty(); // 清空除了 "请选择分类" 选项之外的其他选项
    $search.append(defaultOption); // 重新添加 "请选择分类" 选项

    supplierService.queryAll({sort: "id"}, function (rtn, status) {
      if (rtn.hasError) {
        alert(rock.errorText(rtn, "查询列表失败!"));
      } else if (rtn.notEmpty) {
        var list = rtn.result, option = '<option value="%s">[%s] － %s</option>';
        var $search = $("#supplierId");
        $.each(list, function (i, vo) {
          $search.append(rock.format(option, [vo.id, vo.id, vo.name]));
          // $edit.append(rock.format(option, [vo.id, vo.code, vo.name]));
        });
      } else {
        alert("未查询到部门列表!");
      }
    });
  }


  // 获取按钮和输入框元素
  let addButtons = document.getElementById('addSupplierButton');

  let supplierNameInput = document.getElementById('supplierName');
  let errorElements = null; // 错误提示元素

  // 添加点击事件监听器
  addButtons.addEventListener('click', function (event) {
    event.preventDefault(); // 阻止表单的默认提交行为

    // 获取输入框的值
    let supplierName = supplierNameInput.value;

    // 校验输入框不为空
    if (supplierName.trim() === '') {
      // 输入框为空，显示错误提示
      showErrorMessage('输入框不能为空');
      return; // 停止执行后续逻辑
    }

    // 校验输入内容格式是否符合要求
    let regex = /^[\u4e00-\u9fa5A-Za-z]+-\d{10}$/;
    if (!regex.test(supplierName)) {
      // 输入内容不符合格式要求，显示错误提示
      showErrorMessage('格式必须为 字符串-10个数字');
      return; // 停止执行后续逻辑
    }

// 分解输入内容，提取名字和电话号码
    let name = supplierName.split('-')[0];
    let phone = supplierName.split('-')[1];

    // 创建一个对象，包含要发送到后端的数据
    let data = {
      name: name,
      phone: phone
    };


    // 使用 AJAX 发送数据到后端
    $.ajax({
      url: 'http://127.0.0.1:8081/voucher/supplier/addSupplier',
      type: 'POST',
      //跨域
      xhrFields: {
        withCredentials: true
      },
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function (response) {
        if (response.result) {
          $.toasts({
            type: 'info',
            content: '添加供应商',
            delay: 1000,
            onHidden: function () {
              loadSupplier();
            }
          });
        } else {
          var errorMessage = rock.errorText(response, "添加失败!");
          $.toasts({
            type: 'danger',
            content: errorMessage,
            delay: 3000,
            onHidden: function () {
              if (response.errorCode === "1075") {
                $("#code").focus();
              }
              supplierNameInput.value = '';
            }
          });
        }

      }

    });
  });


  // 监听输入框的输入变化
  supplierNameInput.addEventListener('input', function () {
    hideErrorMessage(); // 隐藏错误提示
    supplierNameInput.classList.remove('error'); // 移除输入框的错误样式
  });

  // 显示错误提示
  function showErrorMessage(message) {
    // 如果已经存在错误提示元素，则更新其内容
    if (errorElements) {
      errorElements.textContent = message;
      return;
    }

    // 创建新的错误提示元素
    errorElements = document.createElement('div');
    errorElements.classList.add('error-message');
    errorElements.textContent = message;

    // 插入到输入框的下方
    supplierNameInput.parentNode.appendChild(errorElements);
    supplierNameInput.classList.add('error'); // 添加输入框的错误样式
  }

  // 隐藏错误提示
  function hideErrorMessage() {
    if (errorElements) {
      errorElements.parentNode.removeChild(errorElements);
      errorElements = null; // 重置错误提示元素
    }
    supplierNameInput.classList.remove('error'); // 移除输入框的错误样式
  }

  $(function ($) {
    // loadCategory();
    loadProduct();
    loadSupplier();

    // 新增
    $('.add-product').on('click', function (event) {
      event.preventDefault();
      // window :建议加上该前缀,否则在子页面中通过parent.modalInstance 获取不到该实例对象,因为它现在处于一个匿名函数里
      window.modalInstance = $.modal({
        url: 'add-product.html',
        title: '新增库存信息',
        //禁用掉底部的按钮区域
        buttons: [],
        modalDialogClass: 'modal-dialog-centered modal-lg',

      })
    })


    $("#form").formValidation({
      //验证字段

      fields: {
        // productName: {
        //   validators: {
        //     notEmpty: {
        //       message: '商品名称不能为空！'
        //     },
        //     stringLength: {
        //       min: 1,
        //       max: 20,
        //       message: '商品名称长度必须在1到20个字符之间'
        //     }
        //   }
        // },
        //   description: {
        //     validators: {

        //       stringLength: {
        //         min: 0,
        //         max: 200,
        //         message: '简介不要超过200字'
        //       }
        //     }
        //   },
        price: {
          validators: {
            notEmpty: {
              message: '单价不能为空'
            },
            regexp: {
              regexp: /^\d+(\.\d{0,2})?$/,
              message: '请输入最多两位小数的数字'
            }

          }
        },

        quantity: {
          validators: {
            notEmpty: {
              message: '进货数量不能为空'
            },
            greaterThan: {
              value: 1,
              inclusive: true,
              message: '数量最小为1'
            }
          }
        },


        supplierId: {
          validators: {
            notEmpty: {
              message: '请选择供应商'
            }
          }
        },
        productId: {
          validators: {
            notEmpty: {
              message: '请选择商品信息'
            }
          }
        },

        emp: {
          validators: {
            notEmpty: {
              message: '请输入操作人代号'
            }
          }
        },

      }
    }).on('success.form.fv', function (e) {

      //阻止表单提交
      e.preventDefault();

      //得到表单对象
      let $form = $(e.target);
      // 获取数据
      let formData = $form.serializeArray();

      // 定义要忽略的输入字段名称

      let ignoredSupplierName = 'supplierName';
      let ignoredUnit = 'unit';

      // 过滤 formData 数组，删除不想要的输入字段
      let filteredFormData = formData.filter(item => {
        return item.name !== ignoredSupplierName && item.name !== ignoredUnit.value;
      });
      // 将过滤后的 formData 数组转换为对象
      let formDataObject = {};
      filteredFormData.forEach(item => {
        formDataObject[item.name] = item.value;
      });

      // 将对象转换为 JSON 字符串
      let serializedData = JSON.stringify(formDataObject);
      //得到序列化数据
      $.ajax({
        url: "http://127.0.0.1:8081/voucher/purchase/add",
        method: 'post',
        contentType: 'application/json',
        data: serializedData,
      }).then(response => {

        if (response.result) {
          $.toasts({
            type: 'success',
            content: '添加成功！',
            delay: 1500,
            autohide: true,
            onHidden: function () {
              parent.modalInstance.setData(true);
              parent.modalInstance.close();
            }
          });
        } else if (response.hasError) {
          // var errorMessage = rock.errorText(response, "注册错误!");
          $.toasts({
            type: 'danger',
            content: '添加失败！',
            delay: 3050, // 将显示时间设置
            // onShown: function () {
            //     if (response.errorCode === "1067") {
            //         $("#code").focus();
            //     }
            // }
          });

        }


      });

    });

    //  }
    // });
  });

</script>

</body>

</html>
